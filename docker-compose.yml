version: "3.4"
services:
  data-analysis-notebook:
    image: docker.bayesimpact.org/bob-emploi/notebooks
    build:
      context: data_analysis
      dockerfile: Dockerfile.notebooks
    ports:
      - "8888:8888"
    volumes:
      - ./data_analysis/data:/home/jovyan/data:rw
      - ./analytics/data:/home/jovyan/data_analytics:ro
      - ./data_analysis:/opt/conda/lib/python3.7/bob_emploi/data_analysis:ro
      - ./data_analysis/notebooks:/home/jovyan/notebooks
    environment:
      AIRTABLE_API_KEY:
      DATA_FOLDER: '/home/jovyan/data'
      CUSTOM_DISPLAY_URL: 'http://localhost:8888'
  data-analysis-prepare:
    image: docker.bayesimpact.org/bob-emploi/data-analysis-prepare
    build:
      context: .
      dockerfile: data_analysis/Dockerfile.prepare
    entrypoint: ./entrypoint.sh
    environment:
      AIRTABLE_API_KEY:
      BOB_PLUGINS:
      EMPLOI_STORE_CLIENT_ID:
      EMPLOI_STORE_CLIENT_SECRET:
    tty: true
  frontend-db:
    build: frontend/server/db
    ports:
      - "27016:27017"
  frontend-dev:
    image: bayesimpact/bob-emploi-dev
    build:
      context: .
      dockerfile: frontend/client/Dockerfile
    command: npm start
    entrypoint: ./entrypoint.sh
    tty: true
    links:
      - frontend-flask
    environment:
      BOB_PLUGINS:
  frontend-flask:
    build:
      context: .
      dockerfile: frontend/server/Dockerfile
      target: server
      args:
        - GIT_SHA1
    image: bayesimpact/bob-emploi-frontend-server
    environment:
      BOB_PLUGINS:
      MONGO_URL:
      USERS_MONGO_URL: 'mongodb://frontend-db/test'
      EVAL_MONGO_URL:
      DEBUG: '1'
      SERVER_VERSION: dev.$USER
      EMPLOI_STORE_CLIENT_ID:
      EMPLOI_STORE_CLIENT_SECRET:
      FACEBOOK_APP_SECRET:
      LINKED_IN_CLIENT_ID:
      LINKED_IN_CLIENT_SECRET:
      MAILJET_SECRET:
      SENTRY_DSN:
      SLACK_FEEDBACK_URL:
      ELASTICSEARCH_URL: 'http://elastic:changeme@elastic-dev:9200'
      EMAILS_FOR_EVALUATIONS:
    links:
      - frontend-db
  frontend-flask-test:
    build:
      context: .
      dockerfile: frontend/server/Dockerfile
      target: test
    image: bayesimpact/bob-emploi-frontend-server-test
    environment:
      MONGO_URL: 'mongodb://frontend-db/test'
      DEBUG: '1'
      SERVER_VERSION: local-test
      TEST_ENV: '1'
    tty: true
    network_mode: none
