{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Resources": {
    "CloudfrontDistribution": {
      "Type": "AWS::CloudFront::Distribution",
      "DeletionPolicy": "Retain",
      "Properties": {
        "DistributionConfig": {
          "Aliases": [
            {
              "Ref": "JobflixDomainName"
            }
          ],
          "CacheBehaviors": [
            {
              "CachedMethods": [
                "HEAD",
                "GET"
              ],
              "AllowedMethods": [
                "HEAD",
                "DELETE",
                "POST",
                "GET",
                "OPTIONS",
                "PUT",
                "PATCH"
              ],
              "Compress": true,
              "DefaultTTL": 86400,
              "FieldLevelEncryptionId": "",
              "ForwardedValues": {
                "Cookies": {
                  "Forward": "none"
                },
                "Headers": [
                  "*"
                ],
                "QueryString": true,
                "QueryStringCacheKeys": []
              },
              "FunctionAssociations": [],
              "LambdaFunctionAssociations": [],
              "MaxTTL": 31536000,
              "MinTTL": 0,
              "PathPattern": "api/*",
              "ResponseHeadersPolicyId": "67f7725c-6f97-4210-82d7-5512b31e9d03",
              "SmoothStreaming": false,
              "TargetOriginId": "ELB-flask",
              "ViewerProtocolPolicy": "https-only"
            },
            {
              "CachedMethods": [
                "HEAD",
                "GET"
              ],
              "AllowedMethods": [
                "HEAD",
                "GET"
              ],
              "CachePolicyId": "8ce898f3-e013-42bb-b7ae-5239de8a1ecb",
              "Compress": false,
              "FieldLevelEncryptionId": "",
              "FunctionAssociations": [],
              "LambdaFunctionAssociations": [],
              "PathPattern": "favicon.ico",
              "ResponseHeadersPolicyId": "67f7725c-6f97-4210-82d7-5512b31e9d03",
              "SmoothStreaming": false,
              "TargetOriginId": "OVH Jobflix assets",
              "ViewerProtocolPolicy": "allow-all"
            }
          ],
          "Comment": "",
          "CustomErrorResponses": [
            {
              "ErrorCachingMinTTL": 300,
              "ErrorCode": 404,
              "ResponseCode": "200",
              "ResponsePagePath": "/upskilling.html"
            },
            {
              "ErrorCachingMinTTL": 300,
              "ErrorCode": 500,
              "ResponseCode": "200",
              "ResponsePagePath": "/upskilling.html"
            }
          ],
          "DefaultCacheBehavior": {
            "CachedMethods": [
              "HEAD",
              "GET"
            ],
            "AllowedMethods": [
              "HEAD",
              "GET"
            ],
            "CachePolicyId": "8ce898f3-e013-42bb-b7ae-5239de8a1ecb",
            "Compress": false,
            "FieldLevelEncryptionId": "",
            "FunctionAssociations": [],
            "LambdaFunctionAssociations": [],
            "ResponseHeadersPolicyId": "67f7725c-6f97-4210-82d7-5512b31e9d03",
            "SmoothStreaming": false,
            "TargetOriginId": "Client-Static-Assets",
            "ViewerProtocolPolicy": "redirect-to-https"
          },
          "DefaultRootObject": "upskilling.html",
          "Enabled": true,
          "HttpVersion": "http2",
          "IPV6Enabled": true,
          "OriginGroups": {
            "Items": [
              {
                "FailoverCriteria": {
                  "StatusCodes": {
                    "Items": [
                      500,
                      502,
                      503
                    ],
                    "Quantity": 3
                  }
                },
                "Id": "Client-Static-Assets",
                "Members": {
                  "Items": [
                    {
                      "OriginId": "PE Static Assets on OVH"
                    },
                    {
                      "OriginId": "S3-bob-emploi-client"
                    }
                  ],
                  "Quantity": 2
                }
              }
            ],
            "Quantity": 1
          },
          "Origins": [
            {
              "ConnectionAttempts": 3,
              "ConnectionTimeout": 10,
              "CustomOriginConfig": {
                "HTTPPort": 80,
                "HTTPSPort": 443,
                "OriginKeepaliveTimeout": 5,
                "OriginProtocolPolicy": "https-only",
                "OriginReadTimeout": 30,
                "OriginSSLProtocols": [
                  "TLSv1.2"
                ]
              },
              "DomainName": {
                "Ref": "DomainName"
              },
              "Id": "ELB-flask",
              "OriginPath": "",
              "OriginShield": {
                "Enabled": false
              }
            },
            {
              "ConnectionAttempts": 3,
              "ConnectionTimeout": 10,
              "CustomOriginConfig": {
                "HTTPPort": 80,
                "HTTPSPort": 443,
                "OriginKeepaliveTimeout": 5,
                "OriginProtocolPolicy": "http-only",
                "OriginReadTimeout": 30,
                "OriginSSLProtocols": [
                  "TLSv1.2"
                ]
              },
              "DomainName": "storage.gra.cloud.ovh.net",
              "Id": "OVH Jobflix assets",
              "OriginPath": {
                "Fn::Sub": "/v1/AUTH_7b9ade05d5f84f719adc2cbc76c07eec/PE%20Static%20Assets/${BobDeployment}/jobflix"
              },
              "OriginShield": {
                "Enabled": false
              }
            },
            {
              "ConnectionAttempts": 3,
              "ConnectionTimeout": 10,
              "CustomOriginConfig": {
                "HTTPPort": 80,
                "HTTPSPort": 443,
                "OriginKeepaliveTimeout": 5,
                "OriginProtocolPolicy": "https-only",
                "OriginReadTimeout": 30,
                "OriginSSLProtocols": [
                  "TLSv1.2"
                ]
              },
              "DomainName": "storage.gra.cloud.ovh.net",
              "Id": "PE Static Assets on OVH",
              "OriginPath": {
                "Fn::Sub": "/v1/AUTH_7b9ade05d5f84f719adc2cbc76c07eec/PE%20Static%20Assets/${BobDeployment}"
              },
              "OriginShield": {
                "Enabled": false
              }
            },
            {
              "ConnectionAttempts": 3,
              "ConnectionTimeout": 10,
              "DomainName": "bob-emploi-client.s3.amazonaws.com",
              "Id": "S3-bob-emploi-client",
              "OriginPath": {
                "Fn::Sub": "/${BobDeployment}"
              },
              "S3OriginConfig": {
                "OriginAccessIdentity": "origin-access-identity/cloudfront/E1839FOY5ZPLQK"
              }
            }
          ],
          "PriceClass": "PriceClass_All",
          "ViewerCertificate": {
            "AcmCertificateArn": {
              "Ref": "JobflixDomainCertificate"
            },
            "MinimumProtocolVersion": "TLSv1.2_2021",
            "SslSupportMethod": "sni-only"
          },
          "WebACLId": ""
        }
      }
    }
  },
  "Parameters": {
    "JobflixDomainName": {
      "Type": "String",
      "Description": "Hostnames to use to publicly serve this Jobflix instance"
    },
    "JobflixDomainCertificate": {
      "Type": "String",
      "Description": "The ARN of a us-east-1 ACM certificate for the Jobflix domain name."
    },
    "DomainName": {
      "Type": "String",
      "Description": "Hostname to use to publicly serve this Bob server instance"
    },
    "BobDeployment": {
      "Type": "String",
      "Default": "fr",
      "Description": "The identifier for this specific deployment in Bob"
    }
  },
  "Outputs": {
    "DistributionDnsName": {
      "Description": "The DNSName of the CloudFront distribution",
      "Value": {
        "Fn::GetAtt": [
          "CloudfrontDistribution",
          "DomainName"
        ]
      }
    }
  }
}
